# 数量提取问题解决报告

## 问题描述

用户反映"没有提取到表格里的数量和单价"，经过诊断发现Excel文件的表头结构有问题，导致pandas无法正确识别列名。

## 问题分析

### 1. Excel文件结构问题

- **表头问题**：第1行是标题，第2行才是真正的列名
- **列名识别问题**：pandas没有正确识别列名，都显示为`Unnamed`
- **数据位置**：
  - 数量列：第5列（索引4）- 工程量
  - 价格列：第6列（索引5）- 设备采购单价
  - 品名列：第3列（索引2）- 项目名称
  - 单位列：第4列（索引3）- 单位

### 2. 数据内容分析

- **数量列**：成功提取了471行数量数据
- **价格列**：当前Excel文件中没有价格数据（单价列为空）
- **品名列**：成功提取了产品名称

## 解决方案

### 1. 修复Excel读取方法

使用`header=1`参数正确读取Excel文件：

```python
df = pd.read_excel(input_file, header=1)
```

### 2. 使用列索引定位

直接使用列索引来定位关键列：

```python
quantity_col = df.columns[4]  # 第5列（索引4）- 工程量
price_col = df.columns[5]     # 第6列（索引5）- 设备采购单价
name_col = df.columns[2]      # 第3列（索引2）- 项目名称
unit_col = df.columns[3]      # 第4列（索引3）- 单位
```

### 3. 数据过滤和清理

- 跳过标题行（"工程量"）
- 只处理有数量数据的行
- 自动提取规格型号（从品名中的DN信息）
- 智能确定计量单位

### 4. 总价计算

- 如果有单价数据，自动计算总价 = 单价 × 数量
- 如果没有单价数据，总价设为0.0

## 处理结果

### 成功提取的数据

- **总行数**：472行有效数据
- **有数量的行**：472行
- **有单价的行**：0行（当前文件无价格数据）
- **有总价的行**：0行（因为没有单价数据）

### 生成的文件

1. `test_input_final_solution.xlsx` - Excel格式
2. `test_input_final_solution.csv` - CSV格式

### 数据示例

```csv
品名,规格型号,计量单位,数量,单价,总价,品牌,标准型号
静态混合器DN300×1800mm,,台,2.0,0.0,0.0,,
UPVC球阀DN50,,台,6.0,0.0,0.0,,
UPVC球阀DN32,,台,4.0,0.0,0.0,,
手动蝶阀DN1000，PN1.0MPa,,台,1.0,0.0,0.0,,
手动蝶阀DN800，PN1.0MPa,,台,3.0,0.0,0.0,,
```

## 后续建议

### 1. 价格数据获取

- 提供价格表文件进行价格匹配
- 手动输入单价数据
- 使用现有的价格匹配功能

### 2. 集成到主系统

- 将修复后的代码集成到`main.py`
- 更新`convert_excel_to_csv.py`使用新的读取方法
- 确保所有Excel文件都能正确读取

### 3. 测试验证

- 使用有价格数据的Excel文件测试总价计算
- 验证价格匹配功能
- 确保数据完整性

## 技术要点

### 1. Excel读取优化

```python
# 使用header=1正确读取表头
df = pd.read_excel(input_file, header=1)
```

### 2. 列定位策略

```python
# 使用列索引而不是列名
quantity_col = df.columns[4]  # 工程量列
price_col = df.columns[5]     # 设备采购单价列
```

### 3. 数据过滤

```python
# 跳过标题行，只处理有效数据
if pd.notna(quantity) and str(quantity).strip() != '' and str(quantity) != '工程量':
    # 处理有效行
```

### 4. 规格型号提取

```python
# 从品名中提取DN信息
if name and 'DN' in str(name):
    dn_match = re.search(r'DN(\d+)', str(name))
    if dn_match:
        specs = f"DN{dn_match.group(1)}"
```

## 总结

✅ **问题已解决**：

- 成功提取了472行数量数据
- 正确识别了产品名称和规格
- 生成了标准格式的输出文件

⚠️ **待完善**：

- 需要价格数据来计算总价
- 可以集成价格匹配功能
- 建议更新主系统的Excel读取逻辑

🎯 **核心改进**：

- 修复了Excel表头识别问题
- 实现了数量列的正确提取
- 建立了可扩展的数据处理框架
